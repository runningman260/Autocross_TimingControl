{% extends "base.html" %}
{% import "bootstrap_wtf.html" as wtf %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center">
        <h2 class="mb-0">All Runs</h2>
        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#addRunModal">
            <i class="bi bi-plus-circle"></i>        Add Missed Start
        </button>
    </div>

    {% if form %}
    <form method="POST" action="/runtable">
        {{ form.hidden_tag() }}
        <div class="row align-items-start">
            <div class="col">
                <table id="runs-table" class="table table-hover">
                    <thead id="runs-table-body">{% include '_run_header.html' %}</thead>
                    <tbody id="runs-table-tbody">
                        {% for run in runs %}
                            {% include '_run.html' %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        </div>
        <div class="row">
            <div class="bottom-fixed">
                <div class="col-lg d-flex flex-wrap justify-content-center align-items-center">
                    <button class="btn btn-default cone mb-2 mx-1 btn-lg flex-fill" id="submit_plus_cone" name="submit_plus_cone" type="submit">
                        <i class="bi bi-plus-lg"></i><i class="bi bi-cone-striped"></i><br> Cone
                    </button>
                    
                    <button class="btn btn-default cone mb-2 mx-1 btn-lg flex-fill" id="submit_minus_cone" name="submit_minus_cone" type="submit">
                        <i class="bi bi-dash-lg"></i> <i class="bi bi-cone-striped"></i><br>Cone
                    </button>
                    <button class="btn btn-info mb-2 mx-1 btn-lg flex-fill" id="submit_plus_oc" name="submit_plus_oc" type="submit">
                        <i class="bi bi-plus-lg"></i><i class="bi bi-flag"></i><br> Off Course
                    </button>
                    <button class="btn btn-info mb-2 mx-1 btn-lg flex-fill" id="submit_minus_oc" name="submit_minus_oc" type="submit">
                        <i class="bi bi-dash-lg"></i><i class="bi bi-flag"></i><br> Off Course
                    </button>
                    <button class="btn btn-danger mb-2 mx-1 btn-lg flex-fill" id="submit_plus_dnf" name="submit_plus_dnf" type="submit">
                        <i class="bi bi-flag-fill"></i><br> DNF
                    </button>
                    
                    <button class="btn btn-danger mb-2 mx-1 btn-lg flex-fill" id="submit_minus_dnf" name="submit_minus_dnf" type="submit">
                       <i class="bi bi-flag-fill text-dark"></i><br> DNS
                    </button>                    
                    <button class="btn btn-dark mb-2 btn-lg mx-1 flex-fill" id="deselect" name="deselect" type="reset">
                        <i class="bi bi-x-circle"></i><br/>Deselect
                    </button>
                    <a class="btn btn-success mb-2 btn-lg mx-1 flex-fill" href="#" id="refresh-button"><i class="bi bi-arrow-clockwise"></i><br> Refresh</a>
                    <!-- <a class="btn btn-success mb-2 btn-lg mx-1 flex-fill" href="{{ url_for('main.fixdata') }}"><i class="bi bi-arrow-clockwise"></i><br> Refresh</a> -->
                </div>
            </div>
        </div>
    </form>
    {% endif %}


    <!-- Modal -->
    {% include '_add_run_modal.html' %}
    <script>
        document.getElementById('refresh-button').addEventListener('click', function(event) {
            event.preventDefault();
            updateRunsTable();
        });

        function updateRunsTable() {
            fetch('/api/runs')
                .then(response => response.json())
                .then(data => {
                    const table = document.getElementById('runs-table-body');
                    const selectedRuns = new Set(
                        Array.from(document.querySelectorAll('input[name="selected_runs"]:checked'))
                            .map(input => input.value)
                    );

                    // Clear existing rows
                    table.querySelectorAll('tr[name="run_row"]').forEach(row => row.remove());

                    // Add new rows
                    data.forEach(run => {
                        const row = document.createElement('tr');
                        row.setAttribute('name', 'run_row');
                        row.setAttribute('id', run.id);

                        row.innerHTML = `
                            <td>
                                <input type="checkbox" id="run_${run.id}" name="selected_runs" value="${run.id}-${run.tag}" ${selectedRuns.has(`${run.id}-${run.tag}`) ? 'checked' : ''}>
                            </td>
                            <td>${run.id}</td>
                            <td>${run.team_name}</td>
                            <td><span title="${run.tag}">...${run.tag.slice(-6)}</span></td>
                            <td>${run.car_number}</td>
                            <td>${run.cones || ''}</td>
                            <td>${run.off_courses || ''}</td>
                            <!-- <td>${run.dnfs || ''}</td> -->
                            <td>${run.raw_time}</td>
                            <td class="${run.dnfs != 0 ? 'table-danger' : (run.cones != 0 || run.off_courses != 0) && run.raw_time == 0 ? 'bg-warning' : run.raw_time == 0 && run.cones == 0 && run.off_courses == 0 ? 'table-success' : ''}">
                                ${run.dnfs > 0 && run.adjusted_time == 0.0 ? 'DNF' : run.dnfs < 0 && run.adjusted_time == 0.0 ? 'DNS' : run.adjusted_time}
                            </td>
                        `;

                        table.appendChild(row);
                    });
                });
        }
        document.querySelector('form').addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(this);
        const submitButton = event.submitter;
        if (submitButton) {
            formData.append(submitButton.name, submitButton.value);
        }
        fetch('/runtable', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showAlert('success', data.message);
                data.runs.forEach(run => {
                console.log('Processing run:', run);
                const row = document.getElementById(run.id);
                row.innerHTML = `
                    <td>
                        <input type="checkbox" id="run_${run.id}" name="selected_runs" value="${run.id}-${run.tag}" checked>
                    </td>
                    <td>${run.id}</td>
                    <td>${run.team_name}</td>
                    <td><span title="${run.tag}">...${run.tag.slice(-6)}</span></td>
                    <td>${run.car_number}</td>
                    <td>${run.cones || ''}</td>
                    <td>${run.off_courses || ''}</td>
                    <td>${run.raw_time}</td>
                    <td class="${run.dnfs != 0 ? 'table-danger' : (run.cones != 0 || run.off_courses != 0) && run.raw_time == 0 ? 'bg-warning' : run.raw_time == 0 && run.cones == 0 && run.off_courses == 0 ? 'table-success' : ''}">
                        ${run.dnfs > 0 && run.adjusted_time == 0.0 ? 'DNF' : run.dnfs < 0 && run.adjusted_time == 0.0 ? 'DNS' : run.adjusted_time}
                    </td>
                `;
            });
            } else {
                showAlert('danger', 'An error occurred. Please try again.');
            }

        });
    });
    </script>
    {% endblock %}